{% extends 'books/base.html' %}

{% block title %}Search Books - University Book Marketplace{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h2 style="color: #007bff;">Search Books</h2>

    <!-- Search Form -->
    <form id="search-form" method="get" style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem;">
        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <select name="mode" id="mode" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                <option value="combined" {% if mode == "combined" %}selected{% endif %}>Combined</option>
                <option value="title" {% if mode == "title" %}selected{% endif %}>Title</option>
                <option value="author" {% if mode == "author" %}selected{% endif %}>Author</option>
                <option value="course" {% if mode == "course" %}selected{% endif %}>Course</option>
                <option value="advanced" {% if mode == "advanced" %}selected{% endif %}>Advanced Search</option>
            </select>

            <!-- Simple Search Input -->
            <input type="text" name="q" id="search-input" value="{{ query }}" placeholder="Search by title, author, or course..."
                   style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">

            <!-- Advanced Search Fields (initially hidden) -->
            <div id="advanced-fields" style="display: none; width: 100%; margin-top: 1rem;">
                <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                    <input type="text" id="title-field" name="title" placeholder="Title"
                           value="{{ request.GET.title|default_if_none:'' }}"
                           style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                    <input type="text" id="author-field" name="author" placeholder="Author"
                           value="{{ request.GET.author|default_if_none:'' }}"
                           style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                    <input type="text" id="course-field" name="course" placeholder="Course"
                           value="{{ request.GET.course|default_if_none:'' }}"
                           style="flex: 1; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
                </div>
            </div>


            <button type="submit" class="btn" style="white-space: nowrap;">
                üîç Search
            </button>
        </div>
    </form>

    <!-- Search Results -->
    <div id="search-results">
        <h3 style="color: #333; margin-bottom: 1rem;">
            {% if query %}
                Search results for "{{ query }}" (<span id="results-count">{{ books|length }}</span> book{{ books|length|pluralize }} found)
            {% else %}
                All Books (<span id="results-count">{{ books|length }}</span> book{{ books|length|pluralize }})
            {% endif %}
        </h3>
    </div>
</div>

<!-- Results Grid -->
<div id="books-container" class="books-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
    {% for listing in listings %}
        <div style="background: white; padding: 1.5rem; border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    border-left: 4px solid #ffc107;">

            <!-- Book Info -->
            <h3 style="margin-top: 0; color: #ffc107;">{{ listing.book.title }}</h3>
            <p style="margin: 0.5rem 0;"><strong>Author:</strong> {{ listing.book.author }}</p>
            <p style="margin: 0.5rem 0;"><strong>Course:</strong> {{ listing.book.course }}</p>

            <hr>

            <!-- Donor Info -->
            <p style="margin: 0.5rem 0;"><strong>Donor:</strong> {{ listing.donor.username }}</p>
            <p style="margin: 0.5rem 0;"><strong>Email:</strong> {{ listing.donor.email }}</p>

            <form method="POST" action="{% url 'donations:request_book' %}" style="margin-top: 1rem;">
                {% csrf_token %}
                <input type="hidden" name="listing_id" value="{{ listing.id }}">
                <button type="submit" class="btn btn-danger btn-sm">Request Book</button>
            </form>

        </div>
    {% endfor %}

    {% for book in books %}
        <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #007bff;">
            <h3 style="margin-top: 0; color: #007bff;">{{ book.title }}</h3>
            <p style="margin: 0.5rem 0;"><strong>Author:</strong> {{ book.author }}</p>
            <p style="margin: 0.5rem 0;"><strong>Course:</strong> {{ book.course }}</p>
            <p style="margin: 0.5rem 0; color: #6c757d; font-size: 0.9rem;">
                <strong>Registered:</strong> {{ book.created_at|date:"M d, Y" }}
            </p>

            <form method="POST" action="{% url 'add_to_shelf' book.id %}" style="margin-top: 1rem;">
                {% csrf_token %}
                <div style="display: flex; gap: 0.5rem;">
                    <select name="tag" class="form-control" style="flex: 1;">
                        <option value="0">Untagged</option>
                        <option value="1">Wanted</option>
                        <option value="2">Reading</option>
                        <option value="3">Read</option>
                    </select>
                    <button type="submit" class="btn btn-primary btn-sm">Add to Shelf</button>
                </div>
            </form>
        </div>
    {% endfor %}
</div>

<style>
.book-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
}
.books-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}
.loading {
    opacity: 0.6;
    pointer-events: none;
}
@media (max-width: 768px) {
    .books-grid { grid-template-columns: 1fr; }
    form > div { flex-direction: column; gap: 0.5rem; }
    form button, form a { width: 100%; }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const modeSelect = document.getElementById("mode");
    const searchInput = document.getElementById("search-input");
    const advancedFields = document.getElementById("advanced-fields");
    const form = document.getElementById("search-form");

    // Helper to toggle visibility with smooth slide
    function toggleVisibility(showAdvanced) {
        if (showAdvanced) {
            // Hide simple search
            searchInput.style.display = "none";

            // Show advanced fields with smooth expand
            advancedFields.style.display = "block";
            advancedFields.style.maxHeight = advancedFields.scrollHeight + "px";
            advancedFields.style.transition = "max-height 0.4s ease-out";
        } else {
            // Collapse advanced fields
            advancedFields.style.maxHeight = "0";
            advancedFields.style.overflow = "hidden";
            advancedFields.style.transition = "max-height 0.3s ease-in";

            // Show simple search again
            searchInput.style.display = "block";
        }
    }

    // Initialize visibility
    toggleVisibility(modeSelect.value === "advanced");

    // Change handler
    modeSelect.addEventListener("change", () => {
        toggleVisibility(modeSelect.value === "advanced");
    });

    // Form submission handler
    form.addEventListener("submit", (e) => {
        e.preventDefault();

        const mode = modeSelect.value;
        const params = new URLSearchParams();
        params.append("mode", mode);

        if (mode === "advanced") {
            const title = document.getElementById("title-field").value.trim();
            const author = document.getElementById("author-field").value.trim();
            const course = document.getElementById("course-field").value.trim();
            if (title) params.append("title", title);
            if (author) params.append("author", author);
            if (course) params.append("course", course);
        } else {
            const query = searchInput.value.trim();
            if (query) params.append("q", query);
        }

        // Update browser URL (so refresh keeps same filters)
        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({}, "", newUrl);
        window.location.href = newUrl;
    });
});
</script>

{% endblock %}
